# N5.2 – AI Logs Explorer (News)

## Overview

This change extends the AI logging tooling so news-centric prompts/responses can be inspected alongside the legacy location flow. Backend filtering and detail APIs are admin-only and power the new “News AI Logs” tab in the admin dashboard.

## Backend changes

### `/api/v1/admin/ai/logs`

- Existing parameters remain intact.
- New query params:
  - `news_only` – boolean toggle (`true` limits to news logs, `false` retrieves all logs).
  - `news_id` – filters by the raw news item id (`raw_ingested_news.id`).
  - `source_key` / `source_name` – filter by the news source metadata via `raw_ingested_news`.
- When any news filter is present the endpoint joins `raw_ingested_news` to return `news_source_key`, `news_source_name`, and `news_id` alongside the existing fields.

### `/api/v1/admin/ai/logs/{log_id}`

- New detail endpoint returning:
  - Metadata: `id`, `action_type`, timestamps, success/error info, `location_id`, `news_id`, and news source/title (when available).
  - Full `prompt`, `raw_response`, and `validated_output` payloads (strings are transparently parsed to JSON objects when possible).
- Secured with the existing `verify_admin_user` dependency.

Backend tests (`tests/test_admin_ai_logs.py`) mock the DB layer to cover:

- News-only and source filters.
- Location regression coverage.
- Detail endpoint success/404/auth flows.

## Frontend changes

### Admin API client (`src/lib/apiAdmin.ts`)

- `AILogItem` now exposes `news_id`, `news_source_key`, and `news_source_name`.
- `listAILogs` accepts the new query params and forwards them to the backend.
- `getAILogDetail(id)` fetches the detail endpoint and returns the prompt/response JSON.

Vitest coverage in `src/lib/__tests__/apiAdmin.spec.ts` verifies query serialization and the new detail helper.

### News AI Diagnostics Panel

- `src/components/admin/NewsAIDiagnosticsPanel.tsx` renders the new tooling:
  - View toggle (News ↔ Location).
  - News-specific filters (`news_id`, `source_key`, `source_name`) with apply/reset controls.
  - Paginated list of logs with status badges, source metadata, and explanations.
  - Detail dialog that loads prompt/raw/validated JSON via `getAILogDetail`.
- Added to the admin dashboard (`AdminHomePage`) as the “News AI Logs” tab.

Component tests in `src/components/admin/__tests__/NewsAIDiagnosticsPanel.spec.tsx` cover:

- Default news-only fetch behaviour.
- Switching to location mode.
- Opening the detail dialog and rendering the returned payload.

## Usage

1. Open `/admin` → “News AI Logs”.
2. Leave the default (News mode) to explore news classifications. Use the filters to narrow by news item or source.
3. Switch to “Location logs” to reuse the view for legacy location prompts.
4. Click “View details” to inspect the exact prompt/response pair plus validated JSON. Use this when tuning prompts or investigating misclassifications.

Both endpoints remain admin-only and reuse Supabase auth, so nothing is exposed publicly.


