# N3.2 – Trending Engine

## Samenvatting
- Trending toont de meest relevante diaspora-/geo-artikelen binnen een kort venster (48 uur).
- Score combineert AI-relevantie, tijdsverval en bronfrequentie om zowel breaking news als veelbesproken bronnen zichtbaar te maken.
- Resultaten zijn beschikbaar via het bestaande `feed=trending` pad én via een dedicated endpoint.

## Trending formule
Laat `diaspora_score = COALESCE(relevance_diaspora, 0)` en `geo_score = COALESCE(relevance_geo, 0)`.

```
base_relevance   = GREATEST(diaspora_score, geo_score)
hours_since      = (NOW() - published_at) in uren
recency_weight   = max(0, 1 - hours_since / 48)
source_freq      = COUNT(*) per source_key binnen 48u
frequency_factor = 1 + min(log(1 + source_freq), 0.5)

trending_score   = base_relevance * recency_weight * frequency_factor
```

Filters:
- `processing_state = 'classified'`
- `published_at >= NOW() - INTERVAL '48 hours'`
- `diaspora_score >= news_diaspora_min_score` **of** `geo_score >= news_geo_min_score` (uit `ai_config`).

Sorting:
- `ORDER BY trending_score DESC, published_at DESC`

## API
- `GET /api/v1/news?feed=trending`
- `GET /api/v1/news/trending`

Query parameters:
- `limit` (1–50, default 20)
- `offset` (>=0)

Respons: `NewsListResponse` met `items`, `total`, `limit`, `offset`. `NewsItem.tags` combineert `location_tag` + `topics`.

## Observability
- Structlog event `news_trending_query` geeft `window_hours`, `limit/offset`, `result_count`, `total`, en eerste 3 `top_samples`.
- `metrics_service.generate_metrics_snapshot()` bevat `news_trending` met:
  - `window_hours`
  - `eligible_count` (totaal binnen venster + threshold)
  - `sample_titles` (top 3)

## Performance & vervolgstappen
- 48u-venster + bestaande indexen (`processing_state`, `published_at`) houden de query snel voor MVP-volume.
- Mogelijke uitbreidingen:
  - Materiële view + index op `(trending_score DESC, published_at DESC)` zodra dataset groeit.
  - Extra signalen (topics/location clusters) in frequentiefactor.
  - Admin UI-kaartje dat `news_trending.sample_titles` toont.

